\ProvidesPackage{luaxml}[{{DATE}} LuaXML package]

\RequirePackage{luacode}

% ToDo: add support for use of  transformation rules for other XML syntaxes -- using LaTeX command?


\begin{luacode*}
luaxml_sty = require "luaxml-sty"
\end{luacode*}


\ExplSyntaxOn

% select current transformer object
\NewDocumentCommand\LXMLUseTransformer{m}{
  \directlua{
luaxml_sty.current.transformation = "#1",
}}

% declare new transformer object
\NewDocumentCommand\LXMLDeclareTransformer{m}{
  \directlua{
    luaxml_sty.transformations["#1"] = luaxml_sty.packages.transform.new()
  }
}

% add transformer rule
% #1 transformer object name -- empty = default
% #2 CSS selector 
% #3 transformer rule
\NewDocumentCommand\LXMLRule{O{} m +v}{
  \directlua{
    luaxml_sty.add_rule("#1", "#2", "\luaescapestring{#3}")
    %luaxml_sty.add_rule("#1", "#2", "#3")
  }
}


% \LXMLSnippet* - parse using XML parser
% \LXMLSnippet  - parse using HTML parser
% #2 transformer name -- empty = default
% #3 XML string
\NewDocumentCommand\LXMLSnippet{s O{} m}{
  \IfBooleanTF{#1}{
    \directlua{luaxml_sty.use_html()}
  }{
    \directlua{luaxml_sty.use_xml()}
  }
  \directlua{
    luaxml_sty.parse_snippet("\luaescapestring{#2}", [[\detokenize{#3}]])
  }
}

\ExplSyntaxOff
\endinput
